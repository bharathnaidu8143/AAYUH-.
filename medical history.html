<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medical History Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: 'Segoe UI'; background: #f4f6f9; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .card, .report-card {
      background: white; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    input, textarea, select {
      width: 100%; margin: 8px 0; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .report-list { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .report-card { width: 300px; position: relative; }
    .thumbnail { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
    .actions button { background: #e74c3c; margin-top: 10px; }
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>ü©∫ Medical History</h2>
      <a href="dashboard.html" style="color: #00796b; text-decoration: none; font-weight: 500;">‚Üê Back to Dashboard</a>
    </div>

    <!-- Upload Form -->
    <div class="card">
      <input type="text" id="title" placeholder="Report Title">
      <textarea id="description" placeholder="Description / Prescription"></textarea>
      <input type="text" id="doctor" placeholder="Doctor Name">
      <input type="date" id="reportDate">
      <!-- üì∏ Added camera support -->
      <input type="file" id="fileInput" accept="image/*,application/pdf" capture="environment" />
      <button id="uploadBtn">Upload</button>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <input type="text" id="filterDoctor" placeholder="Filter by Doctor">
      <input type="date" id="filterDate">
      <select id="filterType">
        <option value="">All Types</option>
        <option value="image">Images</option>
        <option value="pdf">PDFs</option>
      </select>
      <button id="applyFiltersBtn">Apply Filters</button>
      <button id="clearFiltersBtn">Clear Filters</button>
    </div>

    <!-- Report List -->
    <div class="report-list" id="reportList"></div>
  </div>

  <script type="module">
    // ‚úÖ Supabase config (your project)
    const SUPABASE_URL = "https://uydieeizijwzsydydbuv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5ZGllZWl6aWp3enN5ZHlkYnV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTI3MDUsImV4cCI6MjA3NzU4ODcwNX0.5yCKyxHutcGlbkKwIVjpYAQP17PMLGZIwtmVEplo7YE";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ‚úÖ Replace this with your own authentication (e.g., from Firebase or localStorage)
    const userId = localStorage.getItem("uid") || "guest_user"; // placeholder

    document.getElementById("uploadBtn").addEventListener("click", uploadReport);
    document.getElementById("applyFiltersBtn").addEventListener("click", loadReports);
    document.getElementById("clearFiltersBtn").addEventListener("click", clearFilters);

    async function uploadReport() {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const doctor = document.getElementById('doctor').value.trim();
      const date = document.getElementById('reportDate').value;
      const file = document.getElementById('fileInput').files[0];

      if (!title || !description || !doctor || !date || !file) {
        alert("‚ö†Ô∏è Please fill all fields and choose a file.");
        return;
      }

      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.textContent = "Uploading...";
      uploadBtn.disabled = true;

      try {
        const fileExt = file.name.split('.').pop();
        const filePath = `reports/${userId}/${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage
        const { data, error } = await supabase.storage
          .from('medical_reports')
          .upload(filePath, file, { upsert: true });

        if (error) throw error;

        // Get file public URL
        const { data: publicUrl } = supabase.storage.from('medical_reports').getPublicUrl(filePath);

        const fileType = file.type.includes("pdf") ? "pdf" : "image";

        // Save metadata in database
        const { error: insertError } = await supabase
          .from('medical_history')
          .insert([{ user_id: userId, title, description, doctor, date, file_url: publicUrl.publicUrl, file_type: fileType }]);

        if (insertError) throw insertError;

        alert("‚úÖ Report uploaded successfully!");
        clearForm();
        loadReports();
      } catch (err) {
        console.error(err);
        alert("‚ùå Upload failed: " + err.message);
      } finally {
        uploadBtn.textContent = "Upload";
        uploadBtn.disabled = false;
      }
    }

    async function loadReports() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = '<div style="text-align:center;padding:20px;">Loading reports...</div>';

      const doctorFilter = document.getElementById('filterDoctor').value.trim();
      const dateFilter = document.getElementById('filterDate').value;
      const typeFilter = document.getElementById('filterType').value;

      let query = supabase.from('medical_history').select('*').eq('user_id', userId).order('id', { ascending: false });

      const { data, error } = await query;
      if (error) {
        reportList.innerHTML = '<div style="color:#e74c3c;text-align:center;">Error loading reports.</div>';
        console.error(error);
        return;
      }

      reportList.innerHTML = '';
      const filtered = data.filter(r =>
        (!doctorFilter || r.doctor.toLowerCase().includes(doctorFilter.toLowerCase())) &&
        (!dateFilter || r.date === dateFilter) &&
        (!typeFilter || r.file_type === typeFilter)
      );

      if (filtered.length === 0) {
        reportList.innerHTML = '<div style="text-align:center;color:#666;">No reports found.</div>';
        return;
      }

      filtered.forEach(report => {
        const div = document.createElement('div');
        div.className = 'report-card';
        const thumbnail = report.file_type === "image"
          ? `<img src="${report.file_url}" class="thumbnail">`
          : `<img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" class="thumbnail">`;

        div.innerHTML = `
          ${thumbnail}
          <input type="text" value="${report.title}" onchange="updateField(${report.id}, 'title', this.value)">
          <textarea onchange="updateField(${report.id}, 'description', this.value)">${report.description}</textarea>
          <p><strong>Doctor:</strong> ${report.doctor}</p>
          <p><strong>Date:</strong> ${report.date}</p>
          <a href="${report.file_url}" target="_blank" style="color:#00796b;text-decoration:none;">üìÑ View File</a>
          <div class="actions">
            <button onclick="deleteReport(${report.id}, '${report.file_url}')">Delete</button>
          </div>
        `;
        reportList.appendChild(div);
      });
    }

    async function updateField(id, field, value) {
      const { error } = await supabase.from('medical_history').update({ [field]: value }).eq('id', id);
      if (error) alert("‚ùå Update failed: " + error.message);
    }

    async function deleteReport(id, fileUrl) {
      if (!confirm("Are you sure you want to delete this report?")) return;

      try {
        const fileName = fileUrl.split('/').slice(-1)[0];
        await supabase.storage.from('medical_reports').remove([`reports/${userId}/${fileName}`]);
        await supabase.from('medical_history').delete().eq('id', id);
        alert("üóëÔ∏è Report deleted successfully!");
        loadReports();
      } catch (err) {
        alert("‚ùå Delete failed: " + err.message);
      }
    }

    function clearFilters() {
      document.getElementById('filterDoctor').value = '';
      document.getElementById('filterDate').value = '';
      document.getElementById('filterType').value = '';
      loadReports();
    }

    function clearForm() {
      document.getElementById('title').value = '';
      document.getElementById('description').value = '';
      document.getElementById('doctor').value = '';
      document.getElementById('reportDate').value = '';
      document.getElementById('fileInput').value = '';
    }

    // Make global functions accessible
    window.updateField = updateField;
    window.deleteReport = deleteReport;

    // Auto-load
    loadReports();
  </script>
</body>
</html>
