<!DOCTYPE html>
<html>
<head>
  <title>Medical History Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase SDK v9 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDVZNBKutvRFrQOFQunVgSBwJFLMvrct0Q",
      authDomain: "aayuh-c9a87.firebaseapp.com",
      projectId: "aayuh-c9a87",
      storageBucket: "aayuh-c9a87.firebasestorage.app",
      messagingSenderId: "459370049467",
      appId: "1:459370049467:web:4354a11c6b43d3f6dede9e",
      measurementId: "G-GNFKCBES0L"
    };

    // ‚úÖ Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let userId = null;

    // ‚úÖ Check authentication and initialize
    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          console.log("User authenticated:", user.uid);
          
          // Add event listeners only once
          const uploadBtn = document.getElementById("uploadBtn");
          const applyFiltersBtn = document.getElementById("applyFiltersBtn");
          const clearFiltersBtn = document.getElementById("clearFiltersBtn");
          
          if (uploadBtn) {
            uploadBtn.addEventListener("click", uploadReport);
          }
          if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener("click", loadReports);
          }
          if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener("click", clearFilters);
          }
          
          loadReports();
        } else {
          console.log("No user authenticated, redirecting to login");
          window.location.href = "index.html";
        }
      });
    });

    async function uploadReport() {
      if (!userId) {
        alert("‚ùå Please login first.");
        window.location.href = "index.html";
        return;
      }

      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const doctor = document.getElementById('doctor').value;
      const date = document.getElementById('reportDate').value;
      const file = document.getElementById('fileInput').files[0];

      if (!title || !description || !doctor || !date || !file) {
        alert("‚ö†Ô∏è Please fill all fields and choose a file.");
        return;
      }

      try {
        // Show loading state
        const uploadBtn = document.getElementById('uploadBtn');
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = "Uploading...";
        uploadBtn.disabled = true;

        const fileType = file.type.includes("pdf") ? "pdf" : "image";
        const filePath = `reports/${userId}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, filePath);

        await uploadBytes(storageRef, file);
        const fileURL = await getDownloadURL(storageRef);

        await addDoc(collection(db, "medicalReports"), {
          title, description, doctor, date,
          fileURL, fileType, userId,
          timestamp: Date.now()
        });

        alert("‚úÖ Report uploaded successfully!");
        
        // Clear form
        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
        document.getElementById('doctor').value = '';
        document.getElementById('reportDate').value = '';
        document.getElementById('fileInput').value = '';
        
        loadReports();
      } catch (error) {
        console.error("Upload failed:", error);
        alert("‚ùå Upload failed: " + error.message);
      } finally {
        // Reset button state
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.textContent = "Upload";
        uploadBtn.disabled = false;
      }
    }

    // ‚úÖ Load Reports with filters
    async function loadReports() {
      if (!userId) {
        console.log("No user ID available");
        return;
      }

      const reportList = document.getElementById('reportList');
      if (!reportList) {
        console.log("Report list element not found");
        return;
      }

      reportList.innerHTML = '<div style="text-align: center; padding: 20px;">Loading reports...</div>';

      try {
        let q = query(collection(db, "medicalReports"), where("userId", "==", userId), orderBy("timestamp", "desc"));

        const doctorFilter = document.getElementById('filterDoctor')?.value || '';
        const dateFilter = document.getElementById('filterDate')?.value || '';
        const typeFilter = document.getElementById('filterType')?.value || '';

        let querySnapshot = await getDocs(q);
        let hasReports = false;

        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();

          // Apply client-side filters
          if (doctorFilter && data.doctor !== doctorFilter) return;
          if (dateFilter && data.date !== dateFilter) return;
          if (typeFilter && data.fileType !== typeFilter) return;

          hasReports = true;
          const div = document.createElement('div');
          div.className = 'report-card';
          const thumbnail = data.fileType === "image"
            ? `<img src="${data.fileURL}" class="thumbnail" onerror="this.src='https://via.placeholder.com/300x150?text=Image+Error'">`
            : `<img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" class="thumbnail">`;

          div.innerHTML = `
            ${thumbnail}
            <input type="text" value="${data.title}" onchange="updateField('${docSnap.id}', 'title', this.value)">
            <textarea onchange="updateField('${docSnap.id}', 'description', this.value)">${data.description}</textarea>
            <p><strong>Doctor:</strong> ${data.doctor}</p>
            <p><strong>Date:</strong> ${data.date}</p>
            <a href="${data.fileURL}" target="_blank" style="color: #00796b; text-decoration: none;">üìÑ View File</a>
            <div class="actions">
              <button onclick="deleteReport('${docSnap.id}', '${data.fileURL}')" style="background: #e74c3c;">Delete</button>
            </div>
          `;
          reportList.appendChild(div);
        });

        if (!hasReports) {
          reportList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No medical reports found. Upload your first report above!</div>';
        }
      } catch (error) {
        console.error("Error loading reports:", error);
        reportList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading reports. Please try again.</div>';
      }
    }

    // ‚úÖ Update a field
    async function updateField(id, field, value) {
      try {
        await updateDoc(doc(db, "medicalReports", id), { [field]: value });
        console.log("Field updated successfully");
      } catch (error) {
        console.error("Error updating field:", error);
        alert("‚ùå Failed to update: " + error.message);
      }
    }

    // ‚úÖ Delete Report
    async function deleteReport(id, fileURL) {
      if (!confirm("Are you sure you want to delete this report?")) {
        return;
      }

      try {
        // Try to delete from storage first
        if (fileURL) {
          try {
            const fileRef = ref(storage, fileURL);
            await deleteObject(fileRef);
            console.log("File deleted from storage");
          } catch (storageError) {
            console.log("File not found in storage or already deleted:", storageError);
          }
        }

        // Delete from Firestore
        await deleteDoc(doc(db, "medicalReports", id));
        alert("üóëÔ∏è Report deleted successfully!");
        loadReports();
      } catch (error) {
        console.error("Delete error:", error);
        alert("‚ùå Failed to delete: " + error.message);
      }
    }

    // ‚úÖ Clear filters
    function clearFilters() {
      document.getElementById('filterDoctor').value = '';
      document.getElementById('filterDate').value = '';
      document.getElementById('filterType').value = '';
      loadReports();
    }

    // ‚úÖ Expose functions globally
    window.updateField = updateField;
    window.deleteReport = deleteReport;

  </script>

  <style>
    body { font-family: 'Segoe UI'; background: #f4f6f9; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .card, .report-card {
      background: white; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    input, textarea, select {
      width: 100%; margin: 8px 0; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .report-list { display: flex; flex-wrap: wrap; gap: 20px; }
    .report-card { width: 300px; position: relative; }
    .thumbnail { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
    .actions button { background: #e74c3c; margin-top: 10px; }
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>ü©∫ Medical History</h2>
      <a href="dashboard.html" style="color: #00796b; text-decoration: none; font-weight: 500;">‚Üê Back to Dashboard</a>
    </div>

    <!-- Upload Form -->
    <div class="card">
      <input type="text" id="title" placeholder="Report Title">
      <textarea id="description" placeholder="Description / Prescription"></textarea>
      <input type="text" id="doctor" placeholder="Doctor Name">
      <input type="date" id="reportDate">
      <input type="file" id="fileInput" />
      <button id="uploadBtn">Upload</button>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <input type="text" id="filterDoctor" placeholder="Filter by Doctor">
      <input type="date" id="filterDate">
      <select id="filterType">
        <option value="">All Types</option>
        <option value="image">Images</option>
        <option value="pdf">PDFs</option>
      </select>
      <button id="applyFiltersBtn">Apply Filters</button>
      <button id="clearFiltersBtn">Clear Filters</button>
    </div>

    <!-- Report List -->
    <div class="report-list" id="reportList"></div>
  </div>
</body>
</html>
